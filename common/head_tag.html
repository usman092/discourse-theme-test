<script type="text/discourse-plugin" version="0.8">
  const splitUrl = window.location.href.split('?');
  if (splitUrl.length > 1) {
    const urlQueryParams = new URLSearchParams(splitUrl[splitUrl.length-1]);
    if (urlQueryParams.get('openEditor') === 'true') {
        const courseTag = urlQueryParams.get('courseTag');
        const urlParts = splitUrl[0].split('/');
        const lessonTag = urlParts[urlParts.length-1];

        if (lessonTag && courseTag){
            api.modifyClass("model:composer", {
              open(opts) {
                if (!opts) opts = {};
                let categoryObj = this.site.categories.findBy("name", "Courses");
                if (!categoryObj) {
                  // This is to fill category when testing on staging.
                  categoryObj = this.site.categories.findBy("name", "COURSES");
                }
                const id = categoryObj ? categoryObj.id : 0;
                if (!opts.categoryId) {
                  opts.categoryId = id;
                }
                return this._super(...arguments);
              },
            });
            const container = Discourse.__container__;
            const Composer = require("discourse/models/composer").default;
            const controller = container.lookup("controller:navigation/category");
            const composerController = container.lookup("controller:composer");
            composerController.open({
              action: Composer.CREATE_TOPIC,
              draftKey: Composer.DRAFT,
              topicTags: [lessonTag, courseTag]
            });

        }
    }
  }
</script>
